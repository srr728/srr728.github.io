

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Su Rourou">
  <meta name="keywords" content="">
  
    <meta name="description" content="用户端历史订单查询历史订单产品原型 业务规则  分页查询历史订单 可以根据订单状态查询 展示订单数据时，需要展示的数据包括：下单时间、订单状态、订单金额、订单明细（商品名称、图片）  接口设计 代码实现1.user&#x2F;OrderController 1234567&#x2F;&#x2F;历史订单查询：订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 ：@GetMapping(&quot;&#x2F;historyOrd">
<meta property="og:type" content="article">
<meta property="og:title" content="Java项目苍穹外卖：接口开发（4）">
<meta property="og:url" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/index.html">
<meta property="og:site_name" content="surourou">
<meta property="og:description" content="用户端历史订单查询历史订单产品原型 业务规则  分页查询历史订单 可以根据订单状态查询 展示订单数据时，需要展示的数据包括：下单时间、订单状态、订单金额、订单明细（商品名称、图片）  接口设计 代码实现1.user&#x2F;OrderController 1234567&#x2F;&#x2F;历史订单查询：订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 ：@GetMapping(&quot;&#x2F;historyOrd">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%86%8D%E6%9D%A5%E4%B8%80%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%86%8D%E6%9D%A5%E4%B8%80%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%85%A8%E9%83%A8%E8%AE%A2%E5%8D%95%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%BE%85%E6%8E%A5%E5%8D%95%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%BE%85%E6%B4%BE%E9%80%81%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E6%B4%BE%E9%80%81%E4%B8%AD%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%B7%B2%E5%AE%8C%E6%88%90%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%B7%B2%E5%8F%96%E6%B6%88%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%90%84%E4%B8%AA%E7%8A%B6%E6%80%81%E7%9A%84%E8%AE%A2%E5%8D%95%E6%95%B0%E9%87%8F%E7%BB%9F%E8%AE%A1%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%90%84%E4%B8%AA%E7%8A%B6%E6%80%81%E7%9A%84%E8%AE%A2%E5%8D%95%E6%95%B0%E9%87%8F%E7%BB%9F%E8%AE%A1%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8E%A5%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%881%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8E%A5%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%882%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8E%A5%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8B%92%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%881%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8B%92%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%882%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8B%92%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%B4%BE%E9%80%81%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%B4%BE%E9%80%81%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%AE%8C%E6%88%90%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%AE%8C%E6%88%90%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E6%8E%A5%E5%8F%A3%EF%BC%881%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E6%8E%A5%E5%8F%A3%EF%BC%882%EF%BC%89.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E9%85%8D%E7%BD%AEAK.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E6%A0%A1%E9%AA%8C%E6%96%B9%E6%B3%95.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/cron%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%BE%E4%BE%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/cron%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%9C%A8%E7%BA%BF%E7%94%9F%E6%88%90%E5%99%A8.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/SpringTask%E7%9A%84maven%E5%9D%90%E6%A0%87spring-context.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/HTTP%E5%8D%8F%E8%AE%AE%E5%92%8CWebSocket%E5%8D%8F%E8%AE%AE%E5%AF%B9%E6%AF%94.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/WebSocket%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B.png">
<meta property="og:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png">
<meta property="article:published_time" content="2024-11-21T09:37:38.000Z">
<meta property="article:modified_time" content="2024-11-22T02:05:45.471Z">
<meta property="article:author" content="Su Rourou">
<meta property="article:tag" content="Java项目苍穹外卖">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://surourou8.github.io/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png">
  
  
  
  <title>Java项目苍穹外卖：接口开发（4） - surourou</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"surourou8.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"rJpGTwUuJT20doYmqiMHV4UP-gzGzoHsz","app_key":"S6LRxMNdv70LjI3DIZEkvFDc","server_url":"https://rjpgtwuu.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>surourou</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Java项目苍穹外卖：接口开发（4）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-11-21 17:37" pubdate>
          2024年11月21日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          56 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Java项目苍穹外卖：接口开发（4）</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="用户端历史订单"><a href="#用户端历史订单" class="headerlink" title="用户端历史订单"></a>用户端历史订单</h2><h3 id="查询历史订单"><a href="#查询历史订单" class="headerlink" title="查询历史订单"></a>查询历史订单</h3><h4 id="产品原型"><a href="#产品原型" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则</p>
<ul>
<li>分页查询历史订单</li>
<li>可以根据订单状态查询</li>
<li>展示订单数据时，需要展示的数据包括：下单时间、订单状态、订单金额、订单明细（商品名称、图片）</li>
</ul>
<h4 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>user/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//历史订单查询：订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 ：</span><br><span class="hljs-meta">@GetMapping(&quot;/historyOrders&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;历史订单查询&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">page</span><span class="hljs-params">(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> pageSize, Integer status)</span> &#123;<br>    <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> orderService.pageQuery4User(page, pageSize, status);<br>    <span class="hljs-keyword">return</span> Result.success(pageResult);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用户端订单分页查询</span><br>PageResult <span class="hljs-title function_">pageQuery4User</span><span class="hljs-params">(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> pageSize, Integer status)</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用户端订单分页查询</span><br><span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">pageQuery4User</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNum, <span class="hljs-type">int</span> pageSize, Integer status)</span> &#123;<br>    <span class="hljs-comment">// 设置分页</span><br>    PageHelper.startPage(pageNum, pageSize);<br><br>    <span class="hljs-type">OrdersPageQueryDTO</span> <span class="hljs-variable">ordersPageQueryDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrdersPageQueryDTO</span>();<br>    ordersPageQueryDTO.setUserId(BaseContext.getCurrentId());<br>    ordersPageQueryDTO.setStatus(status);<br><br>    <span class="hljs-comment">// 分页条件查询（根据UserId查询当前用户的所有订单）</span><br>    Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);<br><br>    List&lt;OrderVO&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>    <span class="hljs-comment">// 查询出订单明细，并封装入OrderVO进行响应</span><br>    <span class="hljs-keyword">if</span> (page != <span class="hljs-literal">null</span> &amp;&amp; page.getTotal() &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Orders orders : page) &#123;<br>            <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> orders.getId();<span class="hljs-comment">// 订单id</span><br><br>            <span class="hljs-comment">// 查询订单明细</span><br>            List&lt;OrderDetail&gt; orderDetails = orderDetailMapper.getByOrderId(orderId);<br><br>            <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();<br>            BeanUtils.copyProperties(orders, orderVO);<br>            orderVO.setOrderDetailList(orderDetails);<br><br>            list.add(orderVO);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(page.getTotal(), list);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4.<code>OrderMapper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//分页条件查询并按下单时间排序</span><br>Page&lt;Orders&gt; <span class="hljs-title function_">pageQuery</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;<br></code></pre></td></tr></table></figure>

<p>5.<code>OrderMapper.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pageQuery&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Orders&quot;</span>&gt;</span><br>    select * from orders<br>    <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;number != null and number!=&#x27;&#x27;&quot;</span>&gt;</span><br>            and number like concat(&#x27;%&#x27;,#&#123;number&#125;,&#x27;%&#x27;)<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;phone != null and phone!=&#x27;&#x27;&quot;</span>&gt;</span><br>            and phone like concat(&#x27;%&#x27;,#&#123;phone&#125;,&#x27;%&#x27;)<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId != null&quot;</span>&gt;</span><br>            and user_id = #&#123;userId&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null&quot;</span>&gt;</span><br>            and status = #&#123;status&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;beginTime != null&quot;</span>&gt;</span><br>            and order_time <span class="hljs-symbol">&amp;gt;</span>= #&#123;beginTime&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;endTime != null&quot;</span>&gt;</span><br>            and order_time <span class="hljs-symbol">&amp;lt;</span>= #&#123;endTime&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br>    order by order_time desc<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>6.<code>OrderDetailMapper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//根据订单id查询订单明细</span><br><span class="hljs-meta">@Select(&quot;select * from order_detail where order_id = #&#123;orderId&#125;&quot;)</span><br>List&lt;OrderDetail&gt; <span class="hljs-title function_">getByOrderId</span><span class="hljs-params">(Long orderId)</span>;<br></code></pre></td></tr></table></figure>





<h3 id="查询订单详情"><a href="#查询订单详情" class="headerlink" title="查询订单详情"></a>查询订单详情</h3><h4 id="产品原型-1"><a href="#产品原型-1" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="接口设计-1"><a href="#接口设计-1" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>user/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询订单详情</span><br><span class="hljs-meta">@GetMapping(&quot;/orderDetail/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;查询订单详情&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">details</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> orderService.details(id);<br>    <span class="hljs-keyword">return</span> Result.success(orderVO);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询订单详情</span><br>OrderVO <span class="hljs-title function_">details</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询订单详情</span><br><span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">details</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">// 查询该订单对应的菜品/套餐明细</span><br>    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());<br><br>    <span class="hljs-comment">// 将该订单及其详情封装到OrderVO并返回</span><br>    <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();<br>    BeanUtils.copyProperties(orders, orderVO);<br>    orderVO.setOrderDetailList(orderDetailList);<br><br>    <span class="hljs-keyword">return</span> orderVO;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4.<code>OrderMapper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//根据id查询订单</span><br><span class="hljs-meta">@Select(&quot;select * from orders where id = #&#123;id&#125;&quot;)</span><br>Orders <span class="hljs-title function_">getById</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure>



<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><h5 id="【解决配送地址为null】"><a href="#【解决配送地址为null】" class="headerlink" title="【解决配送地址为null】"></a>【解决配送地址为null】</h5><p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_62126710/article/details/140696158">解决黑马苍穹外卖订单详情页面缺少配送地址(address)、订单备注(remark)的问题，以及如何隐藏顾客名字和电话号码-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_60963805/article/details/137890949">苍穹外卖：解决订单没有地址(address)的问题_mars3d的getaddress方法返回未查询到相关结果!-CSDN博客</a></p>
<h3 id="取消订单"><a href="#取消订单" class="headerlink" title="取消订单"></a>取消订单</h3><h4 id="产品原型-2"><a href="#产品原型-2" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>待支付和待接单状态下，用户可直接取消订单</li>
<li>商家已接单状态下，用户取消订单需电话沟通商家</li>
<li>派送中状态下，用户取消订单需电话沟通商家</li>
<li>如果在待接单状态下取消订单，需要给用户退款</li>
<li>取消订单后需要将订单状态修改为“已取消”</li>
</ul>
<h4 id="接口设计-2"><a href="#接口设计-2" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-2"><a href="#代码实现-2" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>user/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用户取消订单</span><br><span class="hljs-meta">@PutMapping(&quot;/cancel/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;取消订单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">cancel</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    orderService.userCancelById(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用户取消订单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">userCancelById</span><span class="hljs-params">(Long id)</span> <span class="hljs-keyword">throws</span> Exception;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用户取消订单</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userCancelById</span><span class="hljs-params">(Long id)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">// 校验订单是否存在</span><br>    <span class="hljs-keyword">if</span> (ordersDB == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_NOT_FOUND);<br>    &#125;<br><br>    <span class="hljs-comment">//订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span><br>    <span class="hljs-keyword">if</span> (ordersDB.getStatus() &gt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);<br>    &#125;<br><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersDB.getId());<br><br>    <span class="hljs-comment">// 订单处于待接单状态下取消，需要进行退款</span><br>    <span class="hljs-keyword">if</span> (ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) &#123;<br>        <span class="hljs-comment">//调用微信支付退款接口</span><br>        weChatPayUtil.refund(<br>            ordersDB.getNumber(), <span class="hljs-comment">//商户订单号</span><br>            ordersDB.getNumber(), <span class="hljs-comment">//商户退款单号</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>),<span class="hljs-comment">//退款金额，单位 元</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>));<span class="hljs-comment">//原订单金额</span><br><br>        <span class="hljs-comment">//支付状态修改为 退款</span><br>        orders.setPayStatus(Orders.REFUND);<br>    &#125;<br><br>    <span class="hljs-comment">// 更新订单状态、取消原因、取消时间</span><br>    orders.setStatus(Orders.CANCELLED);<br>    orders.setCancelReason(<span class="hljs-string">&quot;用户取消&quot;</span>);<br>    orders.setCancelTime(LocalDateTime.now());<br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="再来一单"><a href="#再来一单" class="headerlink" title="再来一单"></a>再来一单</h3><h4 id="产品原型-3"><a href="#产品原型-3" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%86%8D%E6%9D%A5%E4%B8%80%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="接口设计-3"><a href="#接口设计-3" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%94%A8%E6%88%B7%E5%86%8D%E6%9D%A5%E4%B8%80%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>再来一单就是将原订单中的商品重新加入到购物车中</li>
</ul>
<h4 id="代码实现-3"><a href="#代码实现-3" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>user/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//再来一单</span><br><span class="hljs-meta">@PostMapping(&quot;/repetition/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;再来一单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">repetition</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>    orderService.repetition(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//再来一单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">repetition</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//再来一单</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">repetition</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 查询当前用户id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br><br>    <span class="hljs-comment">// 根据订单id查询当前订单详情</span><br>    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(id);<br><br>    <span class="hljs-comment">// 将订单详情对象转换为购物车对象</span><br>    List&lt;ShoppingCart&gt; shoppingCartList = orderDetailList.stream().map(x -&gt; &#123;<br>        <span class="hljs-type">ShoppingCart</span> <span class="hljs-variable">shoppingCart</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCart</span>();<br><br>        <span class="hljs-comment">// 将原订单详情里面的菜品信息重新复制到购物车对象中</span><br>        BeanUtils.copyProperties(x, shoppingCart, <span class="hljs-string">&quot;id&quot;</span>);<br>        shoppingCart.setUserId(userId);<br>        shoppingCart.setCreateTime(LocalDateTime.now());<br><br>        <span class="hljs-keyword">return</span> shoppingCart;<br>    &#125;).collect(Collectors.toList());<br><br>    <span class="hljs-comment">// 将购物车对象批量添加到数据库</span><br>    shoppingCartMapper.insertBatch(shoppingCartList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4.<code>ShoppingCartMapper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 批量插入购物车数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> shoppingCartList</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBatch</span><span class="hljs-params">(List&lt;ShoppingCart&gt; shoppingCartList)</span>;<br></code></pre></td></tr></table></figure>

<p>5.<code>ShoppingCartMapper.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertBatch&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;list&quot;</span>&gt;</span><br>    insert into shopping_cart<br>    (name, image, user_id, dish_id, setmeal_id, dish_flavor, number, amount, create_time)<br>    values<br>    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;shoppingCartList&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;sc&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span>&gt;</span><br>        (#&#123;sc.name&#125;,#&#123;sc.image&#125;,#&#123;sc.userId&#125;,#&#123;sc.dishId&#125;,#&#123;sc.setmealId&#125;,#&#123;sc.dishFlavor&#125;,#&#123;sc.number&#125;,#&#123;sc.amount&#125;,#&#123;sc.createTime&#125;)<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></table></figure>





<h2 id="商家端订单管理模块"><a href="#商家端订单管理模块" class="headerlink" title="商家端订单管理模块"></a>商家端订单管理模块</h2><h3 id="订单搜索"><a href="#订单搜索" class="headerlink" title="订单搜索"></a>订单搜索</h3><h4 id="产品原型-4"><a href="#产品原型-4" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%85%A8%E9%83%A8%E8%AE%A2%E5%8D%95%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%BE%85%E6%8E%A5%E5%8D%95%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%BE%85%E6%B4%BE%E9%80%81%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E6%B4%BE%E9%80%81%E4%B8%AD%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%B7%B2%E5%AE%8C%E6%88%90%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%88%E5%B7%B2%E5%8F%96%E6%B6%88%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>输入订单号&#x2F;手机号进行搜索，支持模糊搜索</li>
<li>根据订单状态进行筛选</li>
<li>下单时间进行时间筛选</li>
<li>搜索内容为空，提示未找到相关订单</li>
<li>搜索结果页，展示包含搜索关键词的内容</li>
<li>分页展示搜索到的订单数据</li>
</ul>
<h4 id="接口设计-4"><a href="#接口设计-4" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-4"><a href="#代码实现-4" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>admin/OrderController</code></p>
<p>在<code>admin</code>包下创建<code>OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//订单管理</span><br><span class="hljs-meta">@RestController(&quot;adminOrderController&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/admin/order&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Api(tags = &quot;订单管理接口&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-comment">//订单搜索</span><br>    <span class="hljs-meta">@GetMapping(&quot;/conditionSearch&quot;)</span><br>    <span class="hljs-meta">@ApiOperation(&quot;订单搜索&quot;)</span><br>    <span class="hljs-keyword">public</span> Result&lt;PageResult&gt; <span class="hljs-title function_">conditionSearch</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;<br>        <span class="hljs-type">PageResult</span> <span class="hljs-variable">pageResult</span> <span class="hljs-operator">=</span> orderService.conditionSearch(ordersPageQueryDTO);<br>        <span class="hljs-keyword">return</span> Result.success(pageResult);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//条件搜索订单</span><br>PageResult <span class="hljs-title function_">conditionSearch</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//订单搜索</span><br><span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">conditionSearch</span><span class="hljs-params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;<br>    PageHelper.startPage(ordersPageQueryDTO.getPage(), ordersPageQueryDTO.getPageSize());<br><br>    Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);<br><br>    <span class="hljs-comment">// 部分订单状态，需要额外返回订单菜品信息，将Orders转化为OrderVO</span><br>    List&lt;OrderVO&gt; orderVOList = getOrderVOList(page);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(page.getTotal(), orderVOList);<br>&#125;<br><br><span class="hljs-keyword">private</span> List&lt;OrderVO&gt; <span class="hljs-title function_">getOrderVOList</span><span class="hljs-params">(Page&lt;Orders&gt; page)</span> &#123;<br>    <span class="hljs-comment">// 需要返回订单菜品信息，自定义OrderVO响应结果</span><br>    List&lt;OrderVO&gt; orderVOList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    List&lt;Orders&gt; ordersList = page.getResult();<br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(ordersList)) &#123;<br>        <span class="hljs-keyword">for</span> (Orders orders : ordersList) &#123;<br>            <span class="hljs-comment">// 将共同字段复制到OrderVO</span><br>            <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderVO</span>();<br>            BeanUtils.copyProperties(orders, orderVO);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">orderDishes</span> <span class="hljs-operator">=</span> getOrderDishesStr(orders);<br><br>            <span class="hljs-comment">// 将订单菜品信息封装到orderVO中，并添加到orderVOList</span><br>            orderVO.setOrderDishes(orderDishes);<br>            orderVOList.add(orderVO);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> orderVOList;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据订单id获取菜品信息字符串</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> orders</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">getOrderDishesStr</span><span class="hljs-params">(Orders orders)</span> &#123;<br>    <span class="hljs-comment">// 查询订单菜品详情信息（订单中的菜品和数量）</span><br>    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());<br><br>    <span class="hljs-comment">// 将每一条订单菜品信息拼接为字符串（格式：宫保鸡丁*3；）</span><br>    List&lt;String&gt; orderDishList = orderDetailList.stream().map(x -&gt; &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">orderDish</span> <span class="hljs-operator">=</span> x.getName() + <span class="hljs-string">&quot;*&quot;</span> + x.getNumber() + <span class="hljs-string">&quot;;&quot;</span>;<br>        <span class="hljs-keyword">return</span> orderDish;<br>    &#125;).collect(Collectors.toList());<br><br>    <span class="hljs-comment">// 将该订单对应的所有菜品信息拼接在一起</span><br>    <span class="hljs-keyword">return</span> String.join(<span class="hljs-string">&quot;&quot;</span>, orderDishList);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="各个状态的订单数量统计"><a href="#各个状态的订单数量统计" class="headerlink" title="各个状态的订单数量统计"></a>各个状态的订单数量统计</h3><h4 id="产品原型-5"><a href="#产品原型-5" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%90%84%E4%B8%AA%E7%8A%B6%E6%80%81%E7%9A%84%E8%AE%A2%E5%8D%95%E6%95%B0%E9%87%8F%E7%BB%9F%E8%AE%A1%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="接口设计-5"><a href="#接口设计-5" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%90%84%E4%B8%AA%E7%8A%B6%E6%80%81%E7%9A%84%E8%AE%A2%E5%8D%95%E6%95%B0%E9%87%8F%E7%BB%9F%E8%AE%A1%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-5"><a href="#代码实现-5" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>admin/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//各个状态的订单数量统计</span><br><span class="hljs-meta">@GetMapping(&quot;/statistics&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;各个状态的订单数量统计&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderStatisticsVO&gt; <span class="hljs-title function_">statistics</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">OrderStatisticsVO</span> <span class="hljs-variable">orderStatisticsVO</span> <span class="hljs-operator">=</span> orderService.statistics();<br>    <span class="hljs-keyword">return</span> Result.success(orderStatisticsVO);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//各个状态的订单数量统计</span><br>OrderStatisticsVO <span class="hljs-title function_">statistics</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//各个状态的订单数量统计</span><br><span class="hljs-keyword">public</span> OrderStatisticsVO <span class="hljs-title function_">statistics</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 根据状态，分别查询出待接单、待派送、派送中的订单数量</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">toBeConfirmed</span> <span class="hljs-operator">=</span> orderMapper.countStatus(Orders.TO_BE_CONFIRMED);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">confirmed</span> <span class="hljs-operator">=</span> orderMapper.countStatus(Orders.CONFIRMED);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">deliveryInProgress</span> <span class="hljs-operator">=</span> orderMapper.countStatus(Orders.DELIVERY_IN_PROGRESS);<br><br>    <span class="hljs-comment">// 将查询出的数据封装到orderStatisticsVO中响应</span><br>    <span class="hljs-type">OrderStatisticsVO</span> <span class="hljs-variable">orderStatisticsVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderStatisticsVO</span>();<br>    orderStatisticsVO.setToBeConfirmed(toBeConfirmed);<br>    orderStatisticsVO.setConfirmed(confirmed);<br>    orderStatisticsVO.setDeliveryInProgress(deliveryInProgress);<br>    <span class="hljs-keyword">return</span> orderStatisticsVO;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4.<code>OrderMapper</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//根据状态统计订单数量</span><br><span class="hljs-meta">@Select(&quot;select count(id) from orders where status = #&#123;status&#125;&quot;)</span><br>Integer <span class="hljs-title function_">countStatus</span><span class="hljs-params">(Integer status)</span>;<br></code></pre></td></tr></table></figure>





<h3 id="查询订单详情-1"><a href="#查询订单详情-1" class="headerlink" title="查询订单详情"></a>查询订单详情</h3><h4 id="产品原型-6"><a href="#产品原型-6" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>订单详情页面需要展示订单基本信息（状态、订单号、下单时间、收货人、电话、收货地址、金额等）</li>
<li>订单详情页面需要展示订单明细数据（商品名称、数量、单价）</li>
</ul>
<h4 id="接口设计-6"><a href="#接口设计-6" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-6"><a href="#代码实现-6" class="headerlink" title="代码实现"></a>代码实现</h4><p><code>admin/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//订单详情</span><br><span class="hljs-meta">@GetMapping(&quot;/details/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;查询订单详情&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;OrderVO&gt; <span class="hljs-title function_">details</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> orderService.details(id);<br>    <span class="hljs-keyword">return</span> Result.success(orderVO);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="接单"><a href="#接单" class="headerlink" title="接单"></a>接单</h3><h4 id="产品原型-7"><a href="#产品原型-7" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8E%A5%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%881%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8E%A5%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%882%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>商家接单其实就是将订单的状态修改为“已接单”</li>
</ul>
<h4 id="接口设计-7"><a href="#接口设计-7" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8E%A5%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-7"><a href="#代码实现-7" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>admin/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//接单</span><br><span class="hljs-meta">@PutMapping(&quot;/confirm&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;接单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">confirm</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersConfirmDTO ordersConfirmDTO)</span> &#123;<br>    orderService.confirm(ordersConfirmDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//接单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(OrdersConfirmDTO ordersConfirmDTO)</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//接单</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(OrdersConfirmDTO ordersConfirmDTO)</span> &#123;<br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> Orders.builder()<br>        .id(ordersConfirmDTO.getId())<br>        .status(Orders.CONFIRMED)<br>        .build();<br><br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="拒单"><a href="#拒单" class="headerlink" title="拒单"></a>拒单</h3><h4 id="产品原型-8"><a href="#产品原型-8" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8B%92%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%881%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8B%92%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B%EF%BC%882%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>商家拒单其实就是将订单状态修改为“已取消”</li>
<li>只有订单处于“待接单”状态时可以执行拒单操作</li>
<li>商家拒单时需要指定拒单原因</li>
<li>商家拒单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<h4 id="接口设计-8"><a href="#接口设计-8" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%8B%92%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-8"><a href="#代码实现-8" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>admin/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//拒单</span><br><span class="hljs-meta">@PutMapping(&quot;/rejection&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;拒单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">rejection</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersRejectionDTO ordersRejectionDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    orderService.rejection(ordersRejectionDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//拒单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">rejection</span><span class="hljs-params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="hljs-keyword">throws</span> Exception;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//拒单</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejection</span><span class="hljs-params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(ordersRejectionDTO.getId());<br><br>    <span class="hljs-comment">// 订单只有存在且状态为2（待接单）才可以拒单</span><br>    <span class="hljs-keyword">if</span> (ordersDB == <span class="hljs-literal">null</span> || !ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);<br>    &#125;<br><br>    <span class="hljs-comment">//支付状态</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">payStatus</span> <span class="hljs-operator">=</span> ordersDB.getPayStatus();<br>    <span class="hljs-keyword">if</span> (payStatus == Orders.PAID) &#123;<br>        <span class="hljs-comment">//用户已支付，需要退款</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">refund</span> <span class="hljs-operator">=</span> weChatPayUtil.refund(<br>            ordersDB.getNumber(),<br>            ordersDB.getNumber(),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>));<br>        log.info(<span class="hljs-string">&quot;申请退款：&#123;&#125;&quot;</span>, refund);<br>    &#125;<br><br>    <span class="hljs-comment">// 拒单需要退款，根据订单id更新订单状态、拒单原因、取消时间</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersDB.getId());<br>    orders.setStatus(Orders.CANCELLED);<br>    orders.setRejectionReason(ordersRejectionDTO.getRejectionReason());<br>    orders.setCancelTime(LocalDateTime.now());<br><br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="取消订单-1"><a href="#取消订单-1" class="headerlink" title="取消订单"></a>取消订单</h3><h4 id="产品原型-9"><a href="#产品原型-9" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>取消订单其实就是将订单状态修改为“已取消”</li>
<li>商家取消订单时需要指定取消原因</li>
<li>商家取消订单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<h4 id="接口设计-9"><a href="#接口设计-9" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-9"><a href="#代码实现-9" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>admin/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//取消订单</span><br><span class="hljs-meta">@PutMapping(&quot;/cancel&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;取消订单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">cancel</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrdersCancelDTO ordersCancelDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    orderService.cancel(ordersCancelDTO);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//商家取消订单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="hljs-keyword">throws</span> Exception;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//取消订单</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(ordersCancelDTO.getId());<br><br>    <span class="hljs-comment">//支付状态</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">payStatus</span> <span class="hljs-operator">=</span> ordersDB.getPayStatus();<br>    <span class="hljs-keyword">if</span> (payStatus == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">//用户已支付，需要退款</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">refund</span> <span class="hljs-operator">=</span> weChatPayUtil.refund(<br>            ordersDB.getNumber(),<br>            ordersDB.getNumber(),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.01</span>));<br>        log.info(<span class="hljs-string">&quot;申请退款：&#123;&#125;&quot;</span>, refund);<br>    &#125;<br><br>    <span class="hljs-comment">// 管理端取消订单需要退款，根据订单id更新订单状态、取消原因、取消时间</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersCancelDTO.getId());<br>    orders.setStatus(Orders.CANCELLED);<br>    orders.setCancelReason(ordersCancelDTO.getCancelReason());<br>    orders.setCancelTime(LocalDateTime.now());<br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="派送订单"><a href="#派送订单" class="headerlink" title="派送订单"></a>派送订单</h3><h4 id="产品原型-10"><a href="#产品原型-10" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%B4%BE%E9%80%81%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>派送订单其实就是将订单状态修改为“派送中”</li>
<li>只有状态为“待派送”的订单可以执行派送订单操作</li>
</ul>
<h4 id="接口设计-10"><a href="#接口设计-10" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E6%B4%BE%E9%80%81%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-10"><a href="#代码实现-10" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>admin/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//派送订单</span><br><span class="hljs-meta">@PutMapping(&quot;/delivery/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;派送订单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">delivery</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    orderService.delivery(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//派送订单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">delivery</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//派送订单</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delivery</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">// 校验订单是否存在，并且状态为3</span><br>    <span class="hljs-keyword">if</span> (ordersDB == <span class="hljs-literal">null</span> || !ordersDB.getStatus().equals(Orders.CONFIRMED)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);<br>    &#125;<br><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersDB.getId());<br>    <span class="hljs-comment">// 更新订单状态,状态转为派送中</span><br>    orders.setStatus(Orders.DELIVERY_IN_PROGRESS);<br><br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="完成订单"><a href="#完成订单" class="headerlink" title="完成订单"></a>完成订单</h3><h4 id="产品原型-11"><a href="#产品原型-11" class="headerlink" title="产品原型"></a>产品原型</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%AE%8C%E6%88%90%E8%AE%A2%E5%8D%95%E4%BA%A7%E5%93%81%E5%8E%9F%E5%9E%8B.png" srcset="/img/loading.gif" lazyload></p>
<p>业务规则：</p>
<ul>
<li>完成订单其实就是将订单状态修改为“已完成”</li>
<li>只有状态为“派送中”的订单可以执行订单完成操作</li>
</ul>
<h4 id="接口设计-11"><a href="#接口设计-11" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%95%86%E5%AE%B6%E5%AE%8C%E6%88%90%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码实现-11"><a href="#代码实现-11" class="headerlink" title="代码实现"></a>代码实现</h4><p>1.<code>admin/OrderController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//完成订单</span><br><span class="hljs-meta">@PutMapping(&quot;/complete/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;完成订单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">complete</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    orderService.complete(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.<code>OrderService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//完成订单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure>

<p>3.<code>OrderServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//完成订单</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">// 校验订单是否存在，并且状态为4</span><br>    <span class="hljs-keyword">if</span> (ordersDB == <span class="hljs-literal">null</span> || !ordersDB.getStatus().equals(Orders.DELIVERY_IN_PROGRESS)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);<br>    &#125;<br><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orders</span>();<br>    orders.setId(ordersDB.getId());<br>    <span class="hljs-comment">// 更新订单状态,状态转为完成</span><br>    orders.setStatus(Orders.COMPLETED);<br>    orders.setDeliveryTime(LocalDateTime.now());<br><br>    orderMapper.update(orders);<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="校验收货地址是否超出配送范围"><a href="#校验收货地址是否超出配送范围" class="headerlink" title="校验收货地址是否超出配送范围"></a>校验收货地址是否超出配送范围</h3><h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><p>注册账号：<a target="_blank" rel="noopener" href="https://passport.baidu.com/v2/?reg&tt=1671699340600&overseas=&gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&tpl=pp&u=https://lbsyun.baidu.com/index.php?title=%E9%A6%96%E9%A1%B5">https://passport.baidu.com/v2/?reg&amp;tt=1671699340600&amp;overseas=&amp;gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&amp;tpl=pp&amp;u=https%3A%2F%2Flbsyun.baidu.com%2Findex.php%3Ftitle%3D%E9%A6%96%E9%A1%B5</a></p>
<p>登录百度地图开放平台：<a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/">https://lbsyun.baidu.com/</a></p>
<p>进入控制台，创建应用，获取<code>AK</code>：</p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E6%8E%A5%E5%8F%A3%EF%BC%881%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E6%8E%A5%E5%8F%A3%EF%BC%882%EF%BC%89.png" srcset="/img/loading.gif" lazyload></p>
<p>相关接口:</p>
<p><a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding">https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding</a></p>
<p><a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1">https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1</a></p>
<h4 id="代码开发"><a href="#代码开发" class="headerlink" title="代码开发"></a>代码开发</h4><p>1.<code>application.yml</code></p>
<p>配置外卖商家店铺地址和百度地图的<code>AK</code>：</p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E9%85%8D%E7%BD%AEAK.png" srcset="/img/loading.gif" lazyload></p>
<p>2.<code>OrderServiceImpl</code></p>
<p>改造<code>OrderServiceImpl</code>，注入上面的配置项：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;sky.shop.address&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String shopAddress;<br><br><span class="hljs-meta">@Value(&quot;$&#123;sky.baidu.ak&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String ak;<br></code></pre></td></tr></table></figure>

<p>在<code>OrderServiceImpl</code>中提供校验方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//检查客户的收货地址是否超出配送范围</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkOutOfRange</span><span class="hljs-params">(String address)</span> &#123;<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    map.put(<span class="hljs-string">&quot;address&quot;</span>,shopAddress);<br>    map.put(<span class="hljs-string">&quot;output&quot;</span>,<span class="hljs-string">&quot;json&quot;</span>);<br>    map.put(<span class="hljs-string">&quot;ak&quot;</span>,ak);<br><br>    <span class="hljs-comment">//获取店铺的经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopCoordinate</span> <span class="hljs-operator">=</span> HttpClientUtil.doGet(<span class="hljs-string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);<br><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSON.parseObject(shopCoordinate);<br>    <span class="hljs-keyword">if</span>(!jsonObject.getString(<span class="hljs-string">&quot;status&quot;</span>).equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;店铺地址解析失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//数据解析</span><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> jsonObject.getJSONObject(<span class="hljs-string">&quot;result&quot;</span>).getJSONObject(<span class="hljs-string">&quot;location&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">lat</span> <span class="hljs-operator">=</span> location.getString(<span class="hljs-string">&quot;lat&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">lng</span> <span class="hljs-operator">=</span> location.getString(<span class="hljs-string">&quot;lng&quot;</span>);<br>    <span class="hljs-comment">//店铺经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopLngLat</span> <span class="hljs-operator">=</span> lat + <span class="hljs-string">&quot;,&quot;</span> + lng;<br><br>    map.put(<span class="hljs-string">&quot;address&quot;</span>,address);<br>    <span class="hljs-comment">//获取用户收货地址的经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">userCoordinate</span> <span class="hljs-operator">=</span> HttpClientUtil.doGet(<span class="hljs-string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);<br><br>    jsonObject = JSON.parseObject(userCoordinate);<br>    <span class="hljs-keyword">if</span>(!jsonObject.getString(<span class="hljs-string">&quot;status&quot;</span>).equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;收货地址解析失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//数据解析</span><br>    location = jsonObject.getJSONObject(<span class="hljs-string">&quot;result&quot;</span>).getJSONObject(<span class="hljs-string">&quot;location&quot;</span>);<br>    lat = location.getString(<span class="hljs-string">&quot;lat&quot;</span>);<br>    lng = location.getString(<span class="hljs-string">&quot;lng&quot;</span>);<br>    <span class="hljs-comment">//用户收货地址经纬度坐标</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">userLngLat</span> <span class="hljs-operator">=</span> lat + <span class="hljs-string">&quot;,&quot;</span> + lng;<br><br>    map.put(<span class="hljs-string">&quot;origin&quot;</span>,shopLngLat);<br>    map.put(<span class="hljs-string">&quot;destination&quot;</span>,userLngLat);<br>    map.put(<span class="hljs-string">&quot;steps_info&quot;</span>,<span class="hljs-string">&quot;0&quot;</span>);<br><br>    <span class="hljs-comment">//路线规划</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> HttpClientUtil.doGet(<span class="hljs-string">&quot;https://api.map.baidu.com/directionlite/v1/driving&quot;</span>, map);<br><br>    jsonObject = JSON.parseObject(json);<br>    <span class="hljs-keyword">if</span>(!jsonObject.getString(<span class="hljs-string">&quot;status&quot;</span>).equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;配送路线规划失败&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//数据解析</span><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jsonObject.getJSONObject(<span class="hljs-string">&quot;result&quot;</span>);<br>    <span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> (JSONArray) result.get(<span class="hljs-string">&quot;routes&quot;</span>);<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">distance</span> <span class="hljs-operator">=</span> (Integer) ((JSONObject) jsonArray.get(<span class="hljs-number">0</span>)).get(<span class="hljs-string">&quot;distance&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(distance &gt; <span class="hljs-number">5000</span>)&#123;<br>        <span class="hljs-comment">//配送距离超过5000米</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(<span class="hljs-string">&quot;超出配送范围&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在<code>OrderServiceImpl</code>的<code>submitOrder</code>方法中调用上面的校验方法：</p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE%E6%A0%A1%E9%AA%8C%E6%96%B9%E6%B3%95.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="订单状态定时处理"><a href="#订单状态定时处理" class="headerlink" title="订单状态定时处理"></a>订单状态定时处理</h2><h3 id="Spring-Task"><a href="#Spring-Task" class="headerlink" title="Spring Task"></a>Spring Task</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><code>Spring Task</code>是<code>Spring</code>框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。</p>
<p>定位：定时任务框架。</p>
<p>作用：定时自动执行某段<code>Java</code>代码。</p>
<p>应用场景：</p>
<ul>
<li>信用卡每月还款提醒。</li>
<li>银行贷款每月还款提醒。</li>
<li>火车票售票系统处理未支付订单。</li>
<li>入职纪念日为用户发送通知。</li>
</ul>
<p>只要是需要定时处理的场景都可以使用<code>Spring Task</code>。</p>
<h4 id="cron表达式"><a href="#cron表达式" class="headerlink" title="cron表达式"></a>cron表达式</h4><p><code>cron</code>表达式其实就是一个字符串，通过<code>cron</code>表达式可以定义任务触发的时间。</p>
<p>构成规则：分为6或7个域，由空格分隔开，每个域代表一个含义。</p>
<p>每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)。</p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/cron%E8%A1%A8%E8%BE%BE%E5%BC%8F%E4%B8%BE%E4%BE%8B.png" srcset="/img/loading.gif" lazyload></p>
<p><code>cron</code>表达式在线生成器：<a target="_blank" rel="noopener" href="https://cron.qqe2.com/">https://cron.qqe2.com/</a></p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/cron%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%9C%A8%E7%BA%BF%E7%94%9F%E6%88%90%E5%99%A8.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="入门案例"><a href="#入门案例" class="headerlink" title="入门案例"></a>入门案例</h4><p><code>Spring Task</code>使用步骤：</p>
<p>导入<code>maven</code>坐标<code>spring-context</code>（已存在）。<img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/SpringTask%E7%9A%84maven%E5%9D%90%E6%A0%87spring-context.png" srcset="/img/loading.gif" lazyload></p>
<p>2.启动类添加注解<code>@EnableScheduling</code>开启任务调度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@EnableScheduling</span><span class="hljs-comment">//开启任务调度</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkyApplication</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>3.自定义定时任务类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-comment">//自定义定时任务类</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> &#123;<br>    <span class="hljs-comment">//定时任务：每隔5秒触发一次</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeTask</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;定时任务开始执行：&#123;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="订单状态定时处理-1"><a href="#订单状态定时处理-1" class="headerlink" title="订单状态定时处理"></a>订单状态定时处理</h3><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p>用户下单后可能存在的情况：</p>
<ul>
<li>下单后未支付，订单一直处于“待支付”状态。</li>
<li>用户收货后管理端未点击完成按钮，订单一直处于“派送中”状态。</li>
</ul>
<p>对于上面两种情况需要通过定时任务来修改订单状态，具体逻辑为：</p>
<ul>
<li>通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”。</li>
<li>通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”。</li>
</ul>
<h4 id="代码开发-1"><a href="#代码开发-1" class="headerlink" title="代码开发"></a>代码开发</h4><p>在<code>OrderMapper</code>接口中扩展方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//根据订单状态和下单时间查询订单</span><br><span class="hljs-meta">@Select(&quot;select * from orders where status = #&#123;status&#125; and order_time &lt; #&#123;orderTime&#125;&quot;)</span><br>List&lt;Orders&gt; <span class="hljs-title function_">getByStatusAndOrderTimeLT</span><span class="hljs-params">(Integer status, LocalDateTime orderTime)</span>;<br></code></pre></td></tr></table></figure>

<p>自定义定时任务类<code>OrderTask</code>。完善定时任务类的<code>processTimeoutOrder</code>方法。完善定时任务类的<code>processDeliveryOrder</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-comment">//定时任务类，定时处理订单状态</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTask</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br><br>    <span class="hljs-comment">//处理超时订单的方法</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 * * * * *&quot;)</span><span class="hljs-comment">//每分钟触发一次</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processTimeoutOrder</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;定时处理超时订单：&#123;&#125;&quot;</span>, LocalDateTime.now());<br><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> LocalDateTime.now().plusMinutes(-<span class="hljs-number">15</span>);<br>        <span class="hljs-comment">//处理15分钟内未支付的订单</span><br><br>        <span class="hljs-comment">//select * from orders where status = ? and order_time &lt; (当前时间-15)</span><br>        List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrderTimeLT(Orders.PENDING_PAYMENT, time);<br><br>        <span class="hljs-keyword">if</span>(ordersList != <span class="hljs-literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">for</span>(Orders orders : ordersList)&#123;<span class="hljs-comment">//取消超时订单</span><br>                orders.setStatus(Orders.CANCELLED);<br>                orders.setCancelReason(<span class="hljs-string">&quot;订单超时，自动取消&quot;</span>);<br>                orders.setCancelTime(LocalDateTime.now());<br>                orderMapper.update(orders);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//处理一直处于派送中状态的订单</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 0 1 * * ?&quot;)</span><span class="hljs-comment">//每天凌晨1点触发一次</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processDeliveryOrder</span><span class="hljs-params">()</span>&#123;<br>        log.info(<span class="hljs-string">&quot;定时处理处于派送中的订单：&#123;&#125;&quot;</span>, LocalDateTime.now());<br><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> LocalDateTime.now().plusMinutes(-<span class="hljs-number">60</span>);<br>        <span class="hljs-comment">//凌晨1点的时候处理前一个小时的订单，也就是前一天派送中的订单</span><br><br>        List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrderTimeLT(Orders.DELIVERY_IN_PROGRESS, time);<br><br>        <span class="hljs-keyword">if</span>(ordersList != <span class="hljs-literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">for</span>(Orders orders : ordersList)&#123;<span class="hljs-comment">//将前一天所有处于派送中的订单设置为完成</span><br>                orders.setStatus(Orders.CONFIRMED);<br>                orderMapper.update(orders);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p><code>WebSocket</code>是基于<code>TCP</code>的一种新的网络协议。它实现了浏览器与服务器全双工通信：浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接， 并进行双向数据传输。</p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/HTTP%E5%8D%8F%E8%AE%AE%E5%92%8CWebSocket%E5%8D%8F%E8%AE%AE%E5%AF%B9%E6%AF%94.png" srcset="/img/loading.gif" lazyload></p>
<p><code>HTTP</code>协议和<code>WebSocket</code>协议对比：</p>
<ol>
<li><code>HTTP</code>是短连接，<code>WebSocket</code>是长连接。</li>
<li><code>HTTP</code>通信是单向的，基于请求响应模式。<code>WebSocket</code>支持双向通信。</li>
<li><code>HTTP</code>和<code>WebSocket</code>底层都是<code>TCP</code>连接。</li>
</ol>
<p><code>WebSocket</code>应用场景：</p>
<ul>
<li>视频弹幕</li>
<li>网页聊天</li>
<li>体育实况更新</li>
<li>股票基金报价实时更新</li>
</ul>
<p><code>WebSocket</code>缺点：</p>
<ul>
<li>服务器长期维护长连接需要一定的成本。</li>
<li>各个浏览器支持程度不一。</li>
<li><code>WebSocket</code>是长连接，受网络限制比较大，需要处理好重连。</li>
</ul>
<p>结论：<code>WebSocket</code>支持双向通信，功能看似比<code>HTTP</code>强大，但是也不可以基于<code>WebSocket</code>开发所有的业务功能。<code>WebSocket</code>并不能完全取代<code>HTTP</code>，它只适合在特定的场景下使用。</p>
<h4 id="入门案例-1"><a href="#入门案例-1" class="headerlink" title="入门案例"></a>入门案例</h4><p>实现步骤：</p>
<p>1.直接使用<code>websocket.html</code>页面作为<code>WebSocket</code>客户端。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">HTML</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>WebSocket Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;send()&quot;</span>&gt;</span>发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;closeWebSocket()&quot;</span>&gt;</span>关闭连接<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;message&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> websocket = <span class="hljs-literal">null</span>;</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> clientId = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>);</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//判断当前浏览器是否支持WebSocket</span></span><br><span class="language-javascript">    <span class="hljs-keyword">if</span>(<span class="hljs-string">&#x27;WebSocket&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-comment">//连接WebSocket节点</span></span><br><span class="language-javascript">        websocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&quot;ws://localhost:8080/ws/&quot;</span>+clientId);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    <span class="hljs-keyword">else</span>&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;Not support websocket&#x27;</span>)</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接发生错误的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;error&quot;</span>);</span><br><span class="language-javascript">    &#125;;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接成功建立的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;连接成功&quot;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//接收到消息的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(event.<span class="hljs-property">data</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//连接关闭的回调方法</span></span><br><span class="language-javascript">    websocket.<span class="hljs-property">onclose</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-string">&quot;close&quot;</span>);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span></span><br><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-property">onbeforeunload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">close</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//将消息显示在网页上</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">setMessageInnerHTML</span>(<span class="hljs-params">innerHTML</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;message&#x27;</span>).<span class="hljs-property">innerHTML</span> += innerHTML + <span class="hljs-string">&#x27;&lt;br/&gt;&#x27;</span>;</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//发送消息</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">var</span> message = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;text&#x27;</span>).<span class="hljs-property">value</span>;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">send</span>(message);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">	</span><br><span class="language-javascript">	<span class="hljs-comment">//关闭连接</span></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">closeWebSocket</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        websocket.<span class="hljs-title function_">close</span>();</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2.导入<code>WebSocket</code>的<code>maven</code>坐标。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>3.导入<code>WebSocket</code>服务端组件<code>WebSocketServer</code>，用于和客户端通信。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.sky.websocket;<br><br><span class="hljs-comment">//WebSocket服务</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketServer</span> &#123;<br><br>    <span class="hljs-comment">//存放会话对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>    <span class="hljs-comment">//连接建立成功调用的方法</span><br>    <span class="hljs-meta">@OnOpen</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onOpen</span><span class="hljs-params">(Session session, <span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;客户端：&quot;</span> + sid + <span class="hljs-string">&quot;建立连接&quot;</span>);<br>        sessionMap.put(sid, session);<br>    &#125;<br><br>    <span class="hljs-comment">//收到客户端消息后调用的方法，参数：message 客户端发送过来的消息</span><br>    <span class="hljs-meta">@OnMessage</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message, <span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;收到来自客户端：&quot;</span> + sid + <span class="hljs-string">&quot;的信息:&quot;</span> + message);<br>    &#125;<br><br>    <span class="hljs-comment">//连接关闭调用的方法</span><br>    <span class="hljs-meta">@OnClose</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClose</span><span class="hljs-params">(<span class="hljs-meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;连接断开:&quot;</span> + sid);<br>        sessionMap.remove(sid);<br>    &#125;<br><br>    <span class="hljs-comment">//群发</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendToAllClient</span><span class="hljs-params">(String message)</span> &#123;<br>        Collection&lt;Session&gt; sessions = sessionMap.values();<br>        <span class="hljs-keyword">for</span> (Session session : sessions) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//服务器向客户端发送消息</span><br>                session.getBasicRemote().sendText(message);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>4.导入配置类<code>WebSocketConfiguration</code>，注册<code>WebSocket</code>的服务端组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.sky.config;<br><br><span class="hljs-comment">//WebSocket配置类，用于注册WebSocket的Bean</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ServerEndpointExporter <span class="hljs-title function_">serverEndpointExporter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerEndpointExporter</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>5.导入定时任务类<code>WebSocketTask</code>，定时向客户端推送数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketTask</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WebSocketServer webSocketServer;<br><br>    <span class="hljs-comment">//通过WebSocket每隔5秒向客户端发送消息</span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageToClient</span><span class="hljs-params">()</span> &#123;<br>        webSocketServer.sendToAllClient(<span class="hljs-string">&quot;这是来自服务端的消息：&quot;</span> + DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;HH:mm:ss&quot;</span>).format(LocalDateTime.now()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>6.运行结果。</p>
<p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/WebSocket%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="来单提醒"><a href="#来单提醒" class="headerlink" title="来单提醒"></a>来单提醒</h3><h4 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h4><p>用户下单并且支付成功后，需要第一时间通知外卖商家。通知的形式有如下两种：</p>
<ul>
<li>语音播报。</li>
<li>弹出提示框。</li>
</ul>
<h4 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h4><p>1.通过<code>WebSocket</code>实现管理端页面和服务端保持长连接状态。</p>
<p>2.当客户支付后，调用<code>WebSocket</code>的相关<code>API</code>实现服务端向客户端推送消息。</p>
<p>3.客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报。</p>
<p>4.约定服务端发送给客户端浏览器的数据格式为<code>JSON</code>，字段包括：<code>type</code>，<code>orderId</code>，<code>content</code>。</p>
<ul>
<li><code>type</code>为消息类型：1为来单提醒，2为客户催单。</li>
<li><code>orderId</code>为订单<code>id</code>。</li>
<li><code>content</code> 为消息内容。</li>
</ul>
<h4 id="代码开发-2"><a href="#代码开发-2" class="headerlink" title="代码开发"></a>代码开发</h4><p>在<code>OrderServiceImpl</code>中注入<code>WebSocketServer</code>对象，修改<code>paySuccess</code>方法，加入如下代码：（这是使用了微信支付的）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>map.put(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-number">1</span>);<span class="hljs-comment">//通知类型 1来单提醒 2客户催单</span><br>map.put(<span class="hljs-string">&quot;orderId&quot;</span>, orders.getId());<span class="hljs-comment">//订单id</span><br>map.put(<span class="hljs-string">&quot;content&quot;</span>,<span class="hljs-string">&quot;订单号:&quot;</span> + outTradeNo);<br><br>webSocketServer.sendToAllClient(JSON.toJSONString(map));<br></code></pre></td></tr></table></figure>

<p>如果跳过微信支付，需要改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> WebSocketServer webSocketServer;<br><br><span class="hljs-comment">//订单支付</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> OrderPaymentVO <span class="hljs-title function_">payment</span><span class="hljs-params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">// 当前登录用户id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> BaseContext.getCurrentId();<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.getById(userId);<br><br>    <span class="hljs-comment">//调用微信支付接口，生成预支付交易单</span><br>    <span class="hljs-comment">/*JSONObject jsonObject = weChatPayUtil.pay(</span><br><span class="hljs-comment">                ordersPaymentDTO.getOrderNumber(), //商户订单号</span><br><span class="hljs-comment">                new BigDecimal(0.01), //支付金额，单位 元</span><br><span class="hljs-comment">                &quot;苍穹外卖订单&quot;, //商品描述</span><br><span class="hljs-comment">                user.getOpenid() //微信用户的openid</span><br><span class="hljs-comment">        );</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        if (jsonObject.getString(&quot;code&quot;) != null &amp;&amp; jsonObject.getString(&quot;code&quot;).equals(&quot;ORDERPAID&quot;)) &#123;</span><br><span class="hljs-comment">            throw new OrderBusinessException(&quot;该订单已支付&quot;);</span><br><span class="hljs-comment">        &#125;*/</span><br><br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>    jsonObject.put(<span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;ORDERPAID&quot;</span>);<br>    <span class="hljs-type">OrderPaymentVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);<br>    vo.setPackageStr(jsonObject.getString(<span class="hljs-string">&quot;package&quot;</span>));<br><br>    <span class="hljs-comment">//为替代微信支付成功后的数据库订单状态更新，多定义一个方法进行修改</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">OrderPaidStatus</span> <span class="hljs-operator">=</span> Orders.PAID; <span class="hljs-comment">//支付状态，已支付</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">OrderStatus</span> <span class="hljs-operator">=</span> Orders.TO_BE_CONFIRMED;  <span class="hljs-comment">//订单状态，待接单</span><br><br>    <span class="hljs-comment">//发现没有将支付时间 check_out属性赋值，所以在这里更新</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">check_out_time</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br><br>    <span class="hljs-comment">//获取订单号码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">orderNumber</span> <span class="hljs-operator">=</span> ordersPaymentDTO.getOrderNumber();<br><br>    log.info(<span class="hljs-string">&quot;调用updateStatus，用于替换微信支付更新数据库状态的问题&quot;</span>);<br>    orderMapper.updateStatus(OrderStatus, OrderPaidStatus, check_out_time, orderNumber);<br><br>    <span class="hljs-comment">// 补充：支付成功之后进行来单提醒。</span><br>    <span class="hljs-comment">// 本来是支付成功后会调用com.sky.controller.notify下回调方法paySuccessNotify，该方法调用了paySuccess，</span><br>    <span class="hljs-comment">// 应该在com.sky.service.impl下的OrderServiceImpl的paySuccess中写，但是因为跳过了微信支付，这里直接下单成功进行来单提醒。</span><br><br>    <span class="hljs-comment">// 通过websocket向客户端浏览器推送消息 type orderId content</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">orders</span> <span class="hljs-operator">=</span> orderMapper.getByNumber(orderNumber);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    map.put(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-number">1</span>);<br>    map.put(<span class="hljs-string">&quot;orderId&quot;</span>, orders.getId());<br>    map.put(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;订单号：&quot;</span> + orderNumber);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.toJSONString(map);<br>    webSocketServer.sendToAllClient(json);<br><br>    <span class="hljs-keyword">return</span> vo;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>浏览器发起的请求为：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">请求 URL: ws:<span class="hljs-comment">//localhost/ws/3lkr84icci</span><br>Request <span class="hljs-keyword">Method</span>: GET<br>状态代码: <span class="hljs-number">101</span> Switching Protocols<br></code></pre></td></tr></table></figure>

<p>请求<code>url</code>中未指定端口，但是<code>nginx</code>中配置了反向代理指定了<code>8080</code>端口，所有能够顺利访问管理端。</p>
<h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><h5 id="【没有语音播报】"><a href="#【没有语音播报】" class="headerlink" title="【没有语音播报】"></a>【没有语音播报】</h5><p>解决：浏览器退出登录，重新登录账号。</p>
<h5 id="【语音播报一直循环】"><a href="#【语音播报一直循环】" class="headerlink" title="【语音播报一直循环】"></a>【语音播报一直循环】</h5><p>解决：注释掉<code>WebSocketTask</code>中的<code>sendMessageToClient</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.sky.task;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketTask</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WebSocketServer webSocketServer;<br><br>    <span class="hljs-comment">//通过WebSocket每隔5秒向客户端发送消息</span><br><span class="hljs-comment">/*    @Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span><br><span class="hljs-comment">    public void sendMessageToClient() &#123;</span><br><span class="hljs-comment">        webSocketServer.sendToAllClient(&quot;这是来自服务端的消息：&quot; + DateTimeFormatter.ofPattern(&quot;HH:mm:ss&quot;).format(LocalDateTime.now()));</span><br><span class="hljs-comment">    &#125;*/</span><br>    <span class="hljs-comment">//注释掉防止一直播放语音</span><br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="客户催单"><a href="#客户催单" class="headerlink" title="客户催单"></a>客户催单</h3><h4 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h4><p>用户在小程序中点击催单按钮后，需要第一时间通知外卖商家。通知的形式有如下两种：</p>
<ul>
<li>语音播报。</li>
<li>弹出提示框。</li>
</ul>
<h4 id="设计-1"><a href="#设计-1" class="headerlink" title="设计"></a>设计</h4><p>1.通过<code>WebSocket</code>实现管理端页面和服务端保持长连接状态。</p>
<p>2.当用户点击催单按钮后，调用<code>WebSocket</code>的相关<code>API</code>实现服务端向客户端推送消息。</p>
<p>3.客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报。</p>
<p>4.约定服务端发送给客户端浏览器的数据格式为<code>JSON</code>，字段包括：<code>type</code>，<code>orderId</code>，<code>content</code>。</p>
<ul>
<li><code>type</code>为消息类型：1为来单提醒，2为客户催单。</li>
<li><code>orderId</code>为订单<code>id</code>。</li>
<li><code>content</code> 为消息内容。</li>
</ul>
<h4 id="接口设计-12"><a href="#接口设计-12" class="headerlink" title="接口设计"></a>接口设计</h4><p><img src="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%884%EF%BC%89/%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="代码开发-3"><a href="#代码开发-3" class="headerlink" title="代码开发"></a>代码开发</h4><p>1.根据用户催单的接口定义，在<code>user/OrderController</code>中创建催单方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//客户催单</span><br><span class="hljs-meta">@GetMapping(&quot;/reminder/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@ApiOperation(&quot;客户催单&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">reminder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>    orderService.reminder(id);<br>    <span class="hljs-keyword">return</span> Result.success();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2.在<code>OrderService</code>接口中声明<code>reminder</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//客户催单</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">reminder</span><span class="hljs-params">(Long id)</span>;<br></code></pre></td></tr></table></figure>

<p>3.在<code>OrderServiceImpl</code>中实现<code>reminder</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//客户催单</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reminder</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">//根据id查询订单</span><br>    <span class="hljs-type">Orders</span> <span class="hljs-variable">ordersDB</span> <span class="hljs-operator">=</span> orderMapper.getById(id);<br><br>    <span class="hljs-comment">//校验订单是否存在</span><br>    <span class="hljs-keyword">if</span>(ordersDB == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderBusinessException</span>(MessageConstant.ORDER_NOT_FOUND);<br>    &#125;<br><br>    <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    map.put(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-number">2</span>);<span class="hljs-comment">//1表示来单提醒，2表示客户催单</span><br>    map.put(<span class="hljs-string">&quot;orderId&quot;</span>, id);<br>    map.put(<span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;订单号：&quot;</span> + ordersDB.getNumber());<br><br>    <span class="hljs-comment">//通过websocket向客户端浏览器推送消息</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.toJSONString(map);<br>    webSocketServer.sendToAllClient(json);<br>&#125;<br></code></pre></td></tr></table></figure>




                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/" class="category-chain-item">Java项目苍穹外卖</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/" class="print-no-link">#Java项目苍穹外卖</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Java项目苍穹外卖：接口开发（4）</div>
      <div>http://surourou8.github.io/2024/11/21/Java项目苍穹外卖：接口开发（4）/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Su Rourou</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年11月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%885%EF%BC%89/" title="Java项目苍穹外卖：接口开发（5）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java项目苍穹外卖：接口开发（5）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/11/21/Java%E9%A1%B9%E7%9B%AE%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%EF%BC%9A%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%EF%BC%883%EF%BC%89/" title="Java项目苍穹外卖：接口开发（3）">
                        <span class="hidden-mobile">Java项目苍穹外卖：接口开发（3）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"rJpGTwUuJT20doYmqiMHV4UP-gzGzoHsz","appKey":"S6LRxMNdv70LjI3DIZEkvFDc","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访问数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
